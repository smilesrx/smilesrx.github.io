---
typora-root-url: Image
---

# 协议

## 1、概念

协议事先约定好，大家共同遵守的一组规则，从应用程序的角度看，协议可理解为数据传输和数据解释的规则；可简单理解为各个主机之间通信所使用的的共同语言。

<img src="/原始协议.png" alt="原始协议" style="zoom:75%;" />

这种在A和B之间被遵守的协议称之为原始协议, 后来经过不断增加完善改进, 最终形成了一个稳定的完整的传输协议, 被广泛应用于各种文件传输, 该协议逐渐就成了一个标准协议。

# 分层模型

## 1、OSI 7层模型

**物数网传会表应**

OSI是Open System Interconnection的缩写, 意为开放式系统互联，该模型定义了不同计算机互联的标准, 是设计和描述计算机网络通信的基本框架。

* 应用层：为客户端提供各种应用服务，email服务、FTP服务、SSH服务、HTTP服务
* 表示层：进行编解码和翻译工作
* 会话层：建立会话和保持会话
* 传输层：定义了端到端的数据传输, TCP  UDP协议
* 网络层：定义了点到点的数据传输, IP协议(路由器)负责对数据加上IP地址和其他的数据以确定传输的目标
* 数据链路层：数据校验, 定义了网络传输的基本单位--帧, ARP协议  RARP协议
* 物理层：通信介质 --- 双绞线、光纤、调制解调器modemn（模数转换和数模转换）

<img src="/OSI模型.png" alt="OSI模型" style="zoom:75%;" />

## 2、TCP/IP 四层模型

TCP/IP协议模型（Transmission Control Protocol/Internet Protocol），包含了一系列构成互联网基础的网络协议，是Internet的核心协议。

* 应用层: 对应会话层,表示层和应用层 --- FTP、email
* 传输层: 对应传输层 --- TCP、UDP
* 网络层: 对应网络层 --- IP、ICMP、IGMP
* 网络接口层: 对应于物理层和数据链路层 --- 为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。

<img src="/TCP模型.png" alt="TCP模型" style="zoom:67%;" />

# 数据通信过程

通信过程：**发送端的层层打包，接受方的层层解包。此操作由内核完成**

<img src="/数据进入协议栈时的封装.png" alt="数据进入协议栈时的封装" style="zoom: 67%;" />

TCP/IP协议通信的过程其实就对应着**数据入栈与出栈的过程**。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。

<img src="/数据的打包和解包过程.png" alt="数据的打包和解包过程" style="zoom: 60%;" />

# 网络应用程序的设计模式

## 1、C/S 设计模式

客户端(client)/服务器(server)模式

* 优点：客户端安装本机上可以保证性能、可以将数据缓存到本地, 提高数据的传输效率, 提高用户体验效果、客户端和服务端由一个团队开发，协议选择灵活。
* 缺点：服务器和客户端都需开发，工作量大，调试困难，开发周期长、需要本地安装, 对客户的电脑安全有一定影响。

## 2、B/S 设计模式

浏览器/web服务模式

* 优点：无需安装客户端、无需开发浏览器，开发周期短,工作量小、移植性好、相对安全
* 缺点：只能选择http协议, 协议选择受限制,、不能缓存数据, 数据传输有限，效率受影响。

# 数据链路层

## 1、数据链路层

负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点,这些**节点是通过MAC来唯一标识的**(MAC,物理地址，一个主机会有一个MAC地址)。

<img src="/数据链路层.jpg" alt="数据链路层" style="zoom:70%;" />

* 封装成帧: 把网络层数据报加头和尾，封装成帧,帧头中包括源MAC地址和目的MAC地址。
* 透明传输:零比特填充、转义字符。
* 可靠传输: 在出错率很低的链路上很少用，但是无线链路WLAN会保证可靠传输。
* 差错检测(CRC):接收者检测错误,如果发现差错，丢弃该帧。

## 2、以太网帧格式

以太网帧格式就是包装在网络接口层(数据链路层)的协议

<img src="/以太网帧格式.png" alt="以太网帧格式" style="zoom:75%;" />

# 网络层

## 1、IP 协议

* IP 协议：是TCP/IP协议的核心，所有的TCP，UDP，ICMP，IGMP的数据都以IP数据格式传输。

  **注意：IP不是可靠的协议**，IP协议没有提供一种数据未传达以后的处理机制。

* IP 地址：在数据链路层中我们一般通过MAC地址来识别不同的节点，而在IP层我们也要有一个类似的**地址标识**，这就是IP地址。

  **32位 IP 地址分为网络位和地址位**

  ```c
  A类IP地址：0.0.0.0~127.0.0.0
  B类IP地址：128.0.0.1~191.255.0.0
  C类IP地址：192.168.0.0~239.255.255.0
  ```

* IP 协议头：

  <img src="/IP协议头.jpg" alt="IP协议头" style="zoom:80%;" />

  16位总长度：最大65536

  8位TTL字段：规定该数据包在穿过多少个路由之后才会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。 最大值255，也就是说一个协议包也就在路由器里面穿行255次就会被抛弃了，根据系统的不同，这个数字也不一样，一般是32或者是64。

  8位协议: 用来区分上层协议是TCP, UDP, ICMP还是IGMP协议。

  16位首部校验和: 只校验IP首部, 数据的校验由更高层协议负责。

  32位源IP地址：共个4字节！我们熟悉的IP都是点分十进制的，4字节, 每字节对应一个点分位，最大为255 ，实际上就是整形数。

## 2、ARP 和 RARP 协议

ARP 是**根据IP地址获取MAC地址**的一种协议。RARP协议的工作与此相反

* ARP（地址解析）协议是一种解析协议，本来主机是完全不知道这个IP对应的是哪个主机的哪个接口，当主机要发送一个IP包的时候，会首先查一下自己的ARP高速缓存（就是一个IP - MAC地址对应表缓存）。
* 如果查询的IP－MAC值对不存在，那么主机就向网络发送一个ARP协议广播包，这个广播包里面就有待查询的IP地址。
* 直接收到这份广播的包的所有主机都会查询自己的IP地址，如果收到广播包的某一个主机发现自己符合条件，那么就准备好一个包含自己的MAC地址的ARP包传送给发送ARP广播的主机。
* 而广播主机拿到ARP包后会更新自己的ARP缓存（就是存放IP - MAC对应表的地方）。发送广播的主机就会用新的ARP缓存数据准备好数据链路层的的数据包发送工作。

![ARP协议-通过IP地址获得MAC地址](/ARP协议-通过IP地址获得MAC地址.png)

## 3、ICMP 协议

IP 协议并不是一个可靠的协议，它不保证数据被送达

保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是ICMP(网络控制报文)协议。ICMP不是高层协议，而是IP层的协议。

当传送IP数据包发生错误。比如主机不可达，路由不可达等，ICMP协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会，这也就是为什么说建立在IP层以上的协议是可能做到安全的原因。

* ping：可以说是ICMP的最著名的应用，是TCP/IP协议的一部分。利用`ping`命令可以检查网络是否连通，可以很好地帮助我们分析和判定网络故障。

  <img src="/ping.png" alt="ping" style="zoom:60%;" />

  它利用ICMP协议包来侦测另一个主机是否可达。原理是用类型码为0的ICMP发请求，受到请求的主机则用类型码为 8 的ICMP回应。ping给出来了传送的时间和TTL的数据。

* Traceroute：是用来侦测主机到目的主机之间所经路由情况的重要工具

  Traceroute原理：它收到到目的主机的IP后，首先给目的主机发送一个TTL=1的UDP数据包，而经过的第一个路由器收到这个数据包以后，就自动把TTL减1，而TTL变为0以后，路由器就把这个包给抛弃了，并同时产生一个主机不可达的ICMP数据报给主机。主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机，然后刺激第二个路由器给主机发ICMP数据报。如此往复直到到达目的主机。这样，traceroute就拿到了所有的路由器IP。

  ![tracertoute](/tracertoute.jpg)

# 传输层

## 1、TCP/UDP协议

TCP/UDP都是是传输层协议，但是两者具有不同的特性，同时也具有不同的应用场景，下面以图表的形式对比分析。

<img src="/TCP-UDP.jpg" alt="TCP-UDP" style="zoom:50%;" />

* 面向报文：面向报文的传输方式是应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则 IP 层需要分片，降低效率。若太短，会使IP太小。
* 面向字节流：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。

## 2、TCP 和 UDP协议的应用

<img src="/TCP-UDP的应用.png" alt="TCP-UDP的应用" style="zoom:50%;" />

* 什么时候用TCP：当对网络通讯质量有要求的时候，比如：整个数据要准确无误的传递给对方，这往往用于一些要求可靠的应用，比如HTTP、HTTPS、FTP等传输文件的协议，POP、SMTP等邮件传输的协议。
* 什么时候用UDP：当对网络通讯质量要求不高的时候，要求网络通讯速度能尽量的快，这时就可以使用UDP。

## 3、UDP 数据报格式

<img src="/UDP数据报格式.png" alt="UDP数据报格式" style="zoom:80%;" />

* 通过IP地址来确定网络环境中的唯一的一台主机
* 主机上使用端口号来区分不同的应用程序
* IP+端口唯一确定唯一一台主机上的一个应用程序

## 3、TCP 数据流格式

![TCP数据流格式](/TCP数据流格式.png)

稳定的, 安全的, 可靠的

* 32位序号：TCP是安全可靠的, 每个数据包都带有序号, 当数据包丢失的时候, 需要重传, 要使用序号进行重传，控制数据有序, 丢包重传。
* 32位确认序号：使用确认序号可以知道对方是否已经收到了, 通过确认序号可以知道哪个序号的数据需要重传。
* 16位窗口大小：滑动窗口(主要进行流量控制)

# 







